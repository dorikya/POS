<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>即売会POS（iPad単体・最新版｜品番太字・右配置）</title>

<!-- iOS web app meta -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="即売会POS">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
  :root { --pad:12px; --gap:8px; --font: 17px; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin:0; font-family: -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", system-ui; font-size: var(--font); background:#f7f7f7; color:#111; }
  header { position:sticky; top:0; background:#fff; padding: var(--pad); border-bottom:1px solid #ddd; z-index:10; }
  header h1 { margin:0; font-size: 20px; }
  #status { font-size: 12px; color:#666; }
  main { padding: var(--pad); }
  .row { display:flex; gap: var(--gap); flex-wrap: wrap; }
  .col { flex:1; min-width: 260px; }
  .card { background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding: var(--pad); box-shadow: 0 1px 2px rgba(0,0,0,.04); }
  .btn { display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; text-align:center; user-select:none; line-height:1.1; }
  .btn-sm { padding:6px 10px; border-radius:8px; }
  .btn.primary { background:#007aff; color:#fff; border-color:#007aff; }
  .btn.warn { background:#b00020; color:#fff; border-color:#b00020; }
  .btn:active { transform: translateY(1px); }
  .btn[disabled] { opacity:.5; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--gap); }
  .tile { border:1px solid #e6e6e6; border-radius:10px; padding:12px; background:#fff; text-align:left; }
  .tile.disabled { filter: grayscale(1); opacity: .5; }
  .tile h3 { margin:4px 0 0; font-size:16px; line-height:1.2; }
  .tile small { color:#444; }
  .tile .meta-line { display:flex; align-items:center; gap:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tile .artist { font-weight:700; font-size:15px; }
  .tile .code { font-weight:800; font-size:15px; letter-spacing:.3px; }
  .tile .code::before { content:"#"; margin-right:1px; }
  input, select, textarea { width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; background:#fff; font-size:16px; }
  label { display:block; margin-top:6px; font-size:14px; color:#444; }
  .toolbar { display:flex; gap: var(--gap); flex-wrap:wrap; margin-bottom: var(--pad); }
  .kpi { background:#fff; border:1px solid #eee; border-radius:10px; padding:10px 12px; }
  .flex { display:flex; gap: var(--gap); }
  .flex-1 { flex:1; }
  .mt { margin-top: var(--pad); }
  .hidden { display:none; }
  .list { max-height: 52vh; overflow:auto; border:1px solid #eee; border-radius:10px; background:#fff; }
  table { width:100%; border-collapse: collapse; }
  th, td { border-bottom:1px solid #f0f0f0; padding:8px; text-align:left; }
  th { position: sticky; top:0; background:#fafafa; z-index:1; }
  .right { text-align:right; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; background:#fafafa; }
  footer { padding: var(--pad); color:#666; font-size:12px; text-align:center; }
  .section-title { margin: 6px 0; color:#333; font-weight:600; }
  .num { font-size:20px; font-weight:700; letter-spacing:0.5px; }
  .price { font-size:22px; font-weight:800; }
  .stock { font-size:18px; font-weight:700; }
  .row-line { display:grid; grid-template-columns: 1fr auto 120px; gap:8px; align-items:center; }
  .op-weak { opacity:.7; }
</style>
</head>
<body>
<header>
  <div class="flex" style="align-items:center; justify-content:space-between;">
    <div>
      <h1>即売会POS（iPad単体）</h1>
      <div id="status">ローカル保存 / オフライン可</div>
    </div>
    <div class="toolbar">
      <button class="btn" onclick="viewSection('sell')">会計</button>
      <button class="btn" onclick="viewSection('stock')">在庫</button>
      <button class="btn" onclick="viewSection('adjust')">在庫調整</button>
      <button class="btn" onclick="viewSection('summary')">サマリー/点検</button>
      <button class="btn" onclick="viewSection('import')">取込</button>
      <button class="btn" onclick="viewSection('export')">出力</button>
      <button class="btn warn" onclick="backup()">バックアップ</button>
    </div>
  </div>
</header>

<main>
<section id="sell" class="">
  <div class="row">
    <div class="col card">
      <div class="section-title">作家を選択</div>
      <input id="artistSearch" placeholder="作家名で検索…" oninput="renderArtistTiles()"/>
      <div id="artistGrid" class="grid mt"></div>
    </div>
    <div class="col card">
      <div class="section-title">商品を選択</div>
      <div class="flex">
        <input id="itemSearch" class="flex-1" placeholder="商品名/品番で検索…" oninput="renderItemTiles()"/>
        <select id="sortItems" onchange="renderItemTiles()">
          <option value="code" selected>品番順</option>
          <option value="name">名前順</option>
          <option value="stock">在庫多い順</option>
          <option value="price">価格安い順</option>
        </select>
      </div>
      <div id="itemGrid" class="grid mt"></div>
    </div>
    <div class="col card">
      <div class="section-title">カート</div>
      <div class="list" id="cartList"></div>
      <div class="mt">
        <div class="flex">
          <div class="kpi flex-1">小計：<b id="subtotal" class="num">¥0</b></div>
          <div class="kpi">点数：<b id="qtysum" class="num">0</b></div>
        </div>
        <div class="mt">
          <label>お預かり（現金のみ）</label>
          <input id="cashReceived" type="number" inputmode="numeric" placeholder="例：1000" oninput="updateChange()">
          <div class="flex mt">
            <div class="kpi flex-1">お釣り：<b id="change" class="num">¥0</b></div>
            <button class="btn" onclick="clearCart()">全てをクリア</button>
            <button class="btn primary" onclick="checkout()">会計確定</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="stock" class="hidden">
  <div class="card">
    <div class="section-title">在庫一覧</div>
    <div class="flex">
      <input id="stockSearch" class="flex-1" placeholder="作家/商品/品番で検索…" oninput="renderStockTable()"/>
      <select id="stockFilter" onchange="renderStockTable()">
        <option value="all">すべて</option>
        <option value="low">在庫少（5以下）</option>
      </select>
    </div>
    <div class="list mt">
      <table>
        <thead>
          <tr><th>作家</th><th>品番</th><th>商品</th><th class="right">価格</th><th class="right">在庫</th><th class="right">操作</th></tr>
        </thead>
        <tbody id="stockTbody"></tbody>
      </table>
    </div>
    <div class="flex mt">
      <button class="btn warn" onclick="deleteAllItems()">全商品を削除</button>
      <button class="btn" onclick="cleanupArtists()">未使用作家を整理</button>
    </div>
  </div>
</section>

<section id="adjust" class="hidden">
  <div class="card">
    <div class="section-title">在庫調整（補充/破損/返品など）</div>
    <div class="flex">
      <input id="adjItemSearch" class="flex-1" placeholder="商品名/品番で検索…" oninput="renderAdjCandidates()"/>
      <div class="pill">端末限定機能</div>
    </div>
    <div class="list mt" id="adjCandidates"></div>
    <div class="mt">
      <label>選択中：</label>
      <div id="adjCurrent" class="pill">未選択</div>
      <label class="mt">数量（+補充 / -減算）</label>
      <input id="adjQty" type="number" inputmode="numeric" placeholder="+5 / -2 など">
      <label>理由</label>
      <input id="adjReason" placeholder="補充（作家持込） / 破損 / 返品 等">
      <button class="btn primary mt" onclick="applyAdjustment()">在庫調整を登録</button>
    </div>
  </div>
</section>

<section id="summary" class="hidden">
  <div class="card">
    <div class="section-title">売上サマリー / 点検</div>
    <div class="flex">
      <div class="flex-1">
        <label>開始日</label><input type="date" id="sumStart">
      </div>
      <div class="flex-1">
        <label>終了日</label><input type="date" id="sumEnd">
      </div>
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <button class="btn" onclick="setToday()">本日</button>
        <button class="btn" onclick="renderSummary()">集計</button>
        <button class="btn" onclick="downloadSummaryCSV()">作家別サマリーCSV</button>
      </div>
    </div>
    <div class="mt">
      <div class="kpi">期間合計：<b id="sumGross" class="num">¥0</b>／点数 <b id="sumQty" class="num">0</b></div>
    </div>
    <div class="mt list" style="max-height:40vh;">
      <table>
        <thead><tr><th>作家</th><th>品番</th><th>商品</th><th class="right">売上数</th><th class="right">売上金額</th></tr></thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>
    <div class="mt">
      <div class="section-title">点検（現金残高）</div>
      <div class="flex">
        <div class="flex-1">
          <label>当日の釣銭元金（開店時1回のみ）</label>
          <input id="cashFloat" type="number" inputmode="numeric" placeholder="例：10000" oninput="saveFloat()">
        </div>
        <div class="kpi">現金売上（受取-釣銭）：<b id="cashNet" class="num">¥0</b></div>
        <div class="kpi">現金残高（元金＋現金売上）：<b id="cashBalance" class="num">¥0</b></div>
      </div>
      <small class="op-weak">※ 閉店時はアプリ操作不要。現金残高が実残と一致するか確認のみ。</small>
    </div>
  </div>
</section>

<section id="import" class="hidden">
  <div class="card">
    <div class="section-title">データ取込（メンバーCSV）</div>
    <p>以下の列を持つCSVを読み込みます（1商品＝1行）：</p>
    <div class="kpi">
      作家名 / 作家コード(任意) / 連絡先 / 連絡方法 / 品番(数字) / 商品名 / 価格(税込) / 初期在庫数 / バリエーション有無 / バリエーション内訳（例：青:5,赤:3） / 再入荷予定
    </div>
    <div class="mt">
      <input type="file" id="importFile" accept=".csv" />
      <button class="btn primary" onclick="importCSV()">読み込む</button>
      <button class="btn" onclick="seedDemo()">デモデータ投入</button>
    </div>
    <div class="flex mt">
      <button class="btn warn" onclick="hardReset()">全データ初期化（在庫・販売履歴・作家含む）</button>
    </div>
    <p class="op-弱 mt">※ 初期化は取り消し不可。事前に「出力→全データバックアップ」を保存してください。</p>
  </div>
</section>

<section id="export" class="hidden">
  <div class="card">
    <div class="section-title">出力</div>
    <div class="grid">
      <div class="tile">
        <h3>在庫スナップショットCSV</h3>
        <small>現在庫をCSVで出力</small><br>
        <button class="btn mt" onclick="downloadStock()">出力</button>
      </div>
      <div class="tile">
        <h3>販売履歴CSV</h3>
        <small>受取金額・釣銭を含む</small><br>
        <button class="btn mt" onclick="downloadTxns()">出力</button>
      </div>
      <div class="tile">
        <h3>在庫調整CSV</h3>
        <small>補充・破損・返品ログ</small><br>
        <button class="btn mt" onclick="downloadAdjs()">出力</button>
      </div>
      <div class="tile">
        <h3>作家別サマリーCSV</h3>
        <small>商品番号順の数量内訳</small><br>
        <button class="btn mt" onclick="downloadSummaryCSV()">出力</button>
      </div>
      <div class="tile">
        <h3>全データバックアップ</h3>
        <small>1ファイル(JSON)に保存</small><br>
        <button class="btn mt" onclick="downloadBackup()">出力</button>
      </div>
    </div>
  </div>
</section>

</main>

<footer>データはこのiPadのSafari（localStorage）に保存されます。Safariのキャッシュ削除は行わないでください。</footer>

<script>
var DBKEY = "fair_pos_db_v3";
var db = { artists: [], items: [], txns: [], adjs: [], contacts: [], receipts: [], cashFloats: {} };
var cart = [];
var currentArtist = null;

function save(){ localStorage.setItem(DBKEY, JSON.stringify(db)); document.getElementById('status').textContent = "保存済み " + new Date().toLocaleString(); }
function load(){
  try { var raw = localStorage.getItem(DBKEY); if(raw){ db = JSON.parse(raw); } } catch(e){ console.log(e); }
  initSummaryDates();
  renderArtistTiles(); renderItemTiles(); renderCart(); renderStockTable(); renderAdjCandidates(); renderSummary();
}
function backup(){ downloadText(JSON.stringify(db, null, 2), "backup_"+ts()+".json"); }

function viewSection(id){
  var secs = document.querySelectorAll('main section');
  for(var i=0;i<secs.length;i++){ secs[i].classList.add('hidden'); }
  var el = document.getElementById(id);
  if(el){ el.classList.remove('hidden'); }
  if(id==='sell'){ renderArtistTiles(); renderItemTiles(); renderCart(); }
  if(id==='stock'){ renderStockTable(); }
  if(id==='adjust'){ renderAdjCandidates(); }
  if(id==='summary'){ renderSummary(); }
}
function ts(){ var d=new Date(); function p(n){ return String(n).padStart(2,'0'); } return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); }
function ymdFromISO(iso){ var d=new Date(iso); function p(n){ return String(n).padStart(2,'0'); } return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate()); }
function todayYMD(){ return ymdFromISO(new Date().toISOString()); }

// ===== helper: code sort =====
function splitCode(c){ var m = String(c).match(/^(\\d+)(?:-(.+))?$/); return m ? [parseInt(m[1],10), m[2]||''] : [0, String(c)]; }
function codeSorter(a, b){ var A=splitCode(a), B=splitCode(b); if(A[0]!==B[0]) return A[0]-B[0]; return String(A[1]).localeCompare(String(B[1]), 'ja'); }

// ===== CSV Import =====
function importCSV(){
  var f = document.getElementById('importFile').files[0]; if(!f){ alert('CSVファイルを選択してください'); return; }
  var reader = new FileReader();
  reader.onload = function(e){
    var text = e.target.result; var rows = parseCSV(text); var header = rows.shift().map(function(s){ return s.trim(); });
    function idx(name){ return header.indexOf(name); }
    var idxArtist = idx('作家名'), idxArtistCode = idx('作家コード'), idxContact = idx('連絡先'), idxContactMethod = idx('連絡方法'), idxCode = idx('品番(数字)'), idxName = idx('商品名'), idxPrice = idx('価格(税込)'), idxStart = idx('初期在庫数'), idxHasVar = idx('バリエーション有無'), idxVar = idx('バリエーション内訳'), idxRestock = idx('再入荷予定');
    if([idxArtist, idxCode, idxName, idxPrice, idxStart].some(function(i){ return i<0; })){ alert('必須列が不足しています。ヘッダー例を確認してください。'); return; }

    var knownArtists = {}; for(var i=0;i<db.artists.length;i++){ knownArtists[db.artists[i].name]=1; }
    for(var rIdx=0; rIdx<rows.length; rIdx++){
      var r = rows[rIdx]; var artist = (r[idxArtist]||'').trim(); if(!artist) continue;
      if(!knownArtists[artist]){ db.artists.push({ id: 'ART-' + (db.artists.length+1), name: artist, code: (r[idxArtistCode]||'').trim() }); knownArtists[artist]=1; }
      if((r[idxContact]||'').trim()){ db.contacts.push({ artist: artist, contact: r[idxContact].trim(), method: (r[idxContactMethod]||'').trim() }); }
    }
    for(var rIdx2=0; rIdx2<rows.length; rIdx2++){
      var rr = rows[rIdx2]; var artist2 = (rr[idxArtist]||'').trim(); var codeRaw = String(rr[idxCode]||'').trim(); var name = (rr[idxName]||'').trim(); var price = Number(String(rr[idxPrice]||'').replace(/[^\d]/g,''))||0; var start = Number(String(rr[idxStart]||'').replace(/[^\d\-]/g,''))||0; var hasVar = ((rr[idxHasVar]||'').trim()==='あり'); var varDef = (rr[idxVar]||'').trim(); var restock = (rr[idxRestock]||'').trim();
      if(!artist2 || !codeRaw || !name) continue;
      var artistObj = null; for(var i2=0;i2<db.artists.length;i2++){ if(db.artists[i2].name===artist2){ artistObj=db.artists[i2]; break; } }
      var artistCode = (artistObj && artistObj.code) ? artistObj.code : codeFromName(artist2);
      if(hasVar && varDef){
        var pairs = varDef.split(',').map(function(s){ return s.trim(); }).filter(function(x){ return !!x; });
        var suffixCode = 'A'.charCodeAt(0);
        for(var pi=0; pi<pairs.length; pi++){
          var p = pairs[pi]; var sp = p.split(':'); var vname = (sp[0]||'').trim(); var vqty = Number(String((sp[1]||'')).replace(/[^\d\-]/g,''))||0; var vkey = String.fromCharCode(suffixCode++);
          db.items.push({ id: "ITM-"+Date.now()+"-"+Math.random().toString(36).slice(2,7), artist: artist2, artistCode: artistCode, code: codeRaw+"-"+vkey, name: name+"（"+vname+"）", price: price, startStock: vqty, adj: 0, sold: 0, restock: restock });
        }
      } else {
        db.items.push({ id: "ITM-"+Date.now()+"-"+Math.random().toString(36).slice(2,7), artist: artist2, artistCode: artistCode, code: codeRaw, name: name, price: price, startStock: start, adj: 0, sold: 0, restock: restock });
      }
    }
    save(); renderArtistTiles(); renderItemTiles(); renderStockTable(); renderAdjCandidates(); renderSummary(); alert('取り込み完了');
  };
  reader.readAsText(f, 'utf-8');
}
function parseCSV(text){
  var rows = []; var row = []; var field = ''; var inQuotes=false;
  for(var i=0;i<text.length;i++){ var c=text[i], n=text[i+1];
    if(inQuotes){ if(c==='"' && n==='"'){ field+='"'; i++; } else if(c==='"'){ inQuotes=false; } else { field+=c; } }
    else { if(c===','){ row.push(field); field=''; } else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; } else if(c==='\r'){ } else if(c==='"'){ inQuotes=true; } else { field+=c; } }
  }
  if(field!==''||row.length){ row.push(field); rows.push(row); }
  return rows;
}

// ===== Sell (Cash-only) =====
function renderArtistTiles(){
  var q = (document.getElementById('artistSearch').value||'').trim().toLowerCase();
  var grid = document.getElementById('artistGrid'); grid.innerHTML='';
  var set = {}; var artistsArr = [];
  for(var i=0;i<db.items.length;i++){ var a=db.items[i].artist; if(!set[a]){ set[a]=1; artistsArr.push(a); } }
  artistsArr.sort();
  var list = artistsArr.filter(function(a){ return a.toLowerCase().includes(q); });
  for(var j=0;j<list.length;j++){
    var aName = list[j];
    var cnt = 0; for(var k=0;k<db.items.length;k++){ if(db.items[k].artist===aName){ cnt++; } }
    var el = document.createElement('div');
    el.className='tile'; el.innerHTML='<h3>'+aName+'</h3><small>'+cnt+' 点</small>';
    el.onclick = (function(an){ return function(){ currentArtist = an; renderItemTiles(); }; })(aName);
    grid.appendChild(el);
  }
}

function renderItemTiles(){
  var grid = document.getElementById('itemGrid'); grid.innerHTML='';
  var q = (document.getElementById('itemSearch').value||'').trim().toLowerCase();
  var sort = document.getElementById('sortItems').value || 'code';
  var items = db.items.slice();
  if(currentArtist) items = items.filter(function(it){ return it.artist===currentArtist; });
  if(q) items = items.filter(function(it){ return (it.name+it.code).toLowerCase().includes(q); });
  for(var i=0;i<items.length;i++){ items[i].stock = items[i].startStock + items[i].adj - items[i].sold; }
  if(sort==='name'){ items.sort(function(a,b){ return a.name.localeCompare(b.name,'ja'); }); }
  else if(sort==='stock'){ items.sort(function(a,b){ return b.stock - a.stock; }); }
  else if(sort==='price'){ items.sort(function(a,b){ return a.price - b.price; }); }
  else { items.sort(function(a,b){ return codeSorter(a.code, b.code); }); }
  for(var j=0;j<items.length;j++){
    var it = items[j]; var disabled = it.stock<=0;
    var el = document.createElement('div'); el.className='tile'+(disabled?' disabled':'');
    el.innerHTML =
      '<div class="meta-line"><span class="artist">'+it.artist+'</span><span class="code">'+it.code+'</span></div>'+
      '<h3>'+it.name+'</h3>'+
      '<div class="price">¥'+(it.price).toLocaleString()+'</div>'+
      '<div class="op-weak">在庫 <span class="stock">'+it.stock+'</span></div>'+
      '<div class="flex mt" style="gap:6px;">'+
        '<button class="btn btn-sm" onclick="addToCart(\''+it.id+'\',-1)" '+(disabled?'disabled':'')+'>−1</button>'+
        '<button class="btn primary btn-sm flex-1" onclick="addToCart(\''+it.id+'\',1)" '+(disabled?'disabled':'')+'>追加</button>'+
        '<button class="btn btn-sm" onclick="addToCart(\''+it.id+'\',+1)" '+(disabled?'disabled':'')+'>＋1</button>'+
      '</div>';
    grid.appendChild(el);
  }
}

function addToCart(itemId, delta){
  var it=null; for(var i=0;i<db.items.length;i++){ if(db.items[i].id===itemId){ it=db.items[i]; break; } }
  if(!it) return;
  var currentStock = it.startStock + it.adj - it.sold;
  if(delta>0 && currentStock<=0){ return; }
  var line=null; for(var j=0;j<cart.length;j++){ if(cart[j].id===itemId){ line=cart[j]; break; } }
  if(!line){ line = { id:itemId, qty:0 }; cart.push(line); }
  line.qty = Math.max(0, (line.qty||0)+delta);
  if(line.qty===0){ cart = cart.filter(function(l){ return l.id!==itemId; }); }
  renderCart();
}
function clearCart(){ cart = []; renderCart(); }

function renderCart(){
  var box = document.getElementById('cartList'); box.innerHTML='';
  var sum=0, cnt=0;
  for(var i=0;i<cart.length;i++){
    var line = cart[i];
    var it=null; for(var j=0;j<db.items.length;j++){ if(db.items[j].id===line.id){ it=db.items[j]; break; } }
    if(!it) continue;
    var lineTotal = it.price * line.qty;
    sum += lineTotal; cnt += line.qty;
    var row = document.createElement('div');
    row.className='row-line';
    row.innerHTML = '<div><div class="pill">'+it.artist+'</div><div>'+it.name+' <small>#'+it.code+'</small></div></div>'+
      '<div class="right">¥'+lineTotal.toLocaleString()+'</div>'+
      '<div class="flex" style="justify-content:flex-end; gap:6px;">'+
      '<button class="btn btn-sm" onclick="addToCart(\''+it.id+'\',-1)">−</button>'+
      '<div style="min-width:36px; text-align:center; padding:6px;">'+line.qty+'</div>'+
      '<button class="btn btn-sm" onclick="addToCart(\''+it.id+'\',+1)">＋</button>'+
      '</div>';
    box.appendChild(row);
  }
  document.getElementById('subtotal').textContent = '¥'+sum.toLocaleString();
  document.getElementById('qtysum').textContent = cnt;
  updateChange();
}
function updateChange(){
  var subtotal = Number((document.getElementById('subtotal').textContent||'').replace(/[^\d]/g,''))||0;
  var receive = Number((document.getElementById('cashReceived').value||'0'));
  var change = Math.max(0, receive - subtotal);
  document.getElementById('change').textContent = '¥'+change.toLocaleString();
}
function checkout(){
  if(cart.length===0){ alert('カートが空です'); return; }
  var subtotal = Number((document.getElementById('subtotal').textContent||'').replace(/[^\d]/g,''))||0;
  var receive = Number((document.getElementById('cashReceived').value||'0'));
  if(receive < subtotal){ alert('受取金額が不足しています'); return; }
  var change = receive - subtotal;
  var rcId = "RC-"+Date.now();
  db.receipts.push({ id: rcId, ts: new Date().toISOString(), subtotal: subtotal, received: receive, change: change });
  for(var i=0;i<cart.length;i++){
    var line = cart[i];
    var it=null; for(var j=0;j<db.items.length;j++){ if(db.items[j].id===line.id){ it=db.items[j]; break; } }
    if(!it) continue;
    it.sold += line.qty;
    db.txns.push({ receiptId: rcId, ts: new Date().toISOString(), artist: it.artist, code: it.code, name: it.name, qty: line.qty, price: it.price, 受取金額: receive, 釣銭: change });
  }
  save();
  cart = [];
  document.getElementById('cashReceived').value='';
  renderCart(); renderItemTiles(); renderStockTable(); renderAdjCandidates(); renderSummary();
  alert('会計完了：合計 ¥'+subtotal.toLocaleString()+'／受取 ¥'+receive.toLocaleString()+'／お釣り ¥'+change.toLocaleString());
}

// ===== Stock (with delete) =====
function renderStockTable(){
  var q = (document.getElementById('stockSearch').value||'').trim().toLowerCase();
  var f = document.getElementById('stockFilter').value;
  var tb = document.getElementById('stockTbody'); tb.innerHTML='';
  var items = db.items.slice();
  for(var i=0;i<items.length;i++){ items[i].stock = items[i].startStock + items[i].adj - items[i].sold; }
  var list = items;
  if(q) list = list.filter(function(it){ return (it.artist+it.name+it.code).toLowerCase().includes(q); });
  if(f==='low') list = list.filter(function(it){ return it.stock<=5; });
  list.sort(function(a,b){
    var c = a.artist.localeCompare(b.artist,'ja'); if(c!==0) return c;
    return codeSorter(a.code, b.code);
  });
  for(var j=0;j<list.length;j++){
    var it = list[j];
    var tr = document.createElement('tr');
    tr.innerHTML = '<td>'+it.artist+'</td><td>#'+it.code+'</td><td>'+it.name+'</td>'+
                   '<td class="right">¥'+it.price.toLocaleString()+'</td>'+
                   '<td class="right">'+it.stock+'</td>'+
                   '<td class="right"><button class="btn btn-sm" onclick="deleteItem(\''+it.id+'\')">削除</button></td>';
    tb.appendChild(tr);
  }
}
function deleteItem(id){
  if(!confirm('この商品を削除しますか？（販売履歴は残ります）')) return;
  db.items = db.items.filter(function(x){ return x.id!==id; });
  save(); renderArtistTiles(); renderItemTiles(); renderStockTable(); renderAdjCandidates(); renderSummary();
}
function deleteAllItems(){
  if(!confirm('全商品を削除します。よろしいですか？（販売履歴は残ります）')) return;
  db.items = [];
  save(); renderArtistTiles(); renderItemTiles(); renderStockTable(); renderAdjCandidates(); renderSummary();
}
function cleanupArtists(){
  var used = {}; for(var i=0;i<db.items.length;i++){ used[db.items[i].artist]=1; }
  db.artists = db.artists.filter(function(a){ return !!used[a.name]; });
  save(); renderArtistTiles();
}

// ===== Adjust =====
var adjTarget = null;
function renderAdjCandidates(){
  var q = (document.getElementById('adjItemSearch').value||'').trim().toLowerCase();
  var box = document.getElementById('adjCandidates'); box.innerHTML='';
  var items = db.items.slice();
  if(q) items = items.filter(function(it){ return (it.name+it.code+it.artist).toLowerCase().includes(q); });
  items.sort(function(a,b){ var c=a.artist.localeCompare(b.artist,'ja'); return c||a.name.localeCompare(b.name,'ja'); });
  for(var i=0;i<items.length;i++){
    var it = items[i]; var stock = it.startStock + it.adj - it.sold;
    var el = document.createElement('div');
    el.style.padding='8px'; el.style.borderBottom='1px solid #f0f0f0'; el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
    el.innerHTML = '<div><div class="pill">'+it.artist+'</div><div>'+it.name+'</div><small>#'+it.code+' / 在庫 '+stock+'</small></div>'+
                   '<button class="btn btn-sm" onclick="selectAdj(\''+it.id+'\')">選択</button>';
    box.appendChild(el);
  }
}
function selectAdj(id){
  for(var i=0;i<db.items.length;i++){ if(db.items[i].id===id){ adjTarget=db.items[i]; break; } }
  if(adjTarget){ document.getElementById('adjCurrent').textContent = adjTarget.artist+'｜'+adjTarget.name+'（#'+adjTarget.code+'）'; }
}
function applyAdjustment(){
  if(!adjTarget){ alert('商品を選択してください'); return; }
  var qty = parseInt(document.getElementById('adjQty').value||'0',10);
  if(!qty){ alert('数量を入力してください'); return; }
  var reason = document.getElementById('adjReason').value||'';
  adjTarget.adj += qty;
  db.adjs.push({ id:'ADJ-'+Date.now(), ts:new Date().toISOString(), itemId: adjTarget.id, artist: adjTarget.artist, code: adjTarget.code, name: adjTarget.name, qty: qty, reason: reason });
  save();
  document.getElementById('adjQty').value=''; document.getElementById('adjReason').value='';
  renderStockTable(); renderAdjCandidates(); renderSummary();
  alert('在庫調整を登録しました');
}

// ===== Summary / Inspection =====
function initSummaryDates(){
  var s = document.getElementById('sumStart');
  var e = document.getElementById('sumEnd');
  var t = todayYMD();
  s.value = t; e.value = t;
  var f = db.cashFloats[t] || 0;
  var cf = document.getElementById('cashFloat');
  if(cf) cf.value = f || '';
}
function setToday(){
  var t = todayYMD();
  document.getElementById('sumStart').value = t;
  document.getElementById('sumEnd').value = t;
  renderSummary();
}
function betweenDates(iso, startYMD, endYMD){
  var d = ymdFromISO(iso);
  return (d>=startYMD && d<=endYMD);
}
function renderSummary(){
  var start = document.getElementById('sumStart').value || todayYMD();
  var end = document.getElementById('sumEnd').value || start;
  var tbody = document.getElementById('summaryBody'); tbody.innerHTML='';
  var acc = {};
  var gross=0, qty=0;
  for(var i=0;i<db.txns.length;i++){
    var t = db.txns[i];
    if(!betweenDates(t.ts, start, end)) continue;
    if(!acc[t.artist]) acc[t.artist] = {};
    if(!acc[t.artist][t.code]) acc[t.artist][t.code] = { name: t.name, qty: 0, amt: 0 };
    acc[t.artist][t.code].qty += t.qty;
    acc[t.artist][t.code].amt += t.qty * t.price;
    gross += t.qty * t.price;
    qty += t.qty;
  }
  var artists = Object.keys(acc).sort(function(a,b){ return a.localeCompare(b,'ja'); });
  for(var ai=0; ai<artists.length; ai++){
    var ar = artists[ai];
    var codes = Object.keys(acc[ar]).sort(function(a,b){ return codeSorter(a,b); });
    for(var ci=0; ci<codes.length; ci++){
      var code = codes[ci];
      var row = acc[ar][code];
      var tr = document.createElement('tr');
      tr.innerHTML = '<td>'+ar+'</td><td>#'+code+'</td><td>'+row.name+'</td><td class="right">'+row.qty+'</td><td class="right">¥'+row.amt.toLocaleString()+'</td>';
      tbody.appendChild(tr);
    }
  }
  document.getElementById('sumGross').textContent = '¥'+gross.toLocaleString();
  document.getElementById('sumQty').textContent = qty;
  var day = start===end ? start : todayYMD();
  var net = 0;
  for(var r=0;r<db.receipts.length;r++){
    var rc = db.receipts[r];
    if(ymdFromISO(rc.ts)===day){ net += (rc.received - rc.change); }
  }
  var base = Number(document.getElementById('cashFloat').value|| db.cashFloats[day] || 0);
  document.getElementById('cashNet').textContent = '¥'+net.toLocaleString();
  document.getElementById('cashBalance').textContent = '¥'+(base+net).toLocaleString();
}
function saveFloat(){
  var day = (document.getElementById('sumStart').value || todayYMD());
  var val = Number(document.getElementById('cashFloat').value||0);
  db.cashFloats[day] = val;
  save(); renderSummary();
}
function buildSummaryRows(start, end){
  var rows = [];
  var acc = {};
  for(var i=0;i<db.txns.length;i++){
    var t = db.txns[i];
    if(!betweenDates(t.ts, start, end)) continue;
    var key = t.artist+"||"+t.code;
    if(!acc[key]) acc[key] = { 作家: t.artist, 品番: t.code, 商品: t.name, 売上数: 0, 売上金額: 0 };
    acc[key].売上数 += t.qty;
    acc[key].売上金額 += t.qty * t.price;
  }
  var arr = Object.keys(acc).map(function(k){ return acc[k]; });
  arr.sort(function(a,b){ var c = a.作家.localeCompare(b.作家,'ja'); if(c!==0) return c; return codeSorter(a.品番, b.品番); });
  return arr;
}
function downloadSummaryCSV(){
  var start = document.getElementById('sumStart').value || todayYMD();
  var end = document.getElementById('sumEnd').value || start;
  var rows = buildSummaryRows(start, end);
  downloadText(toCSV(rows), "artist_summary_"+start+"_to_"+end+".csv");
}

// ===== Export =====
function downloadText(text, filename){
  var blob = new Blob([text], {type:'text/plain'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
}
function toCSV(rows){
  if(rows.length===0) return "";
  var keys = Object.keys(rows[0]);
  function esc(s){ return '"'+String(s).replace(/"/g,'""')+'"'; }
  var header = keys.map(esc).join(',');
  var lines = rows.map(function(r){ return keys.map(function(k){ return esc(r[k]||''); }).join(','); });
  return [header].concat(lines).join('\n');
}
function downloadStock(){
  var rows = db.items.map(function(it){
    var stock = it.startStock + it.adj - it.sold;
    return { 作家: it.artist, 作家コード: it.artistCode||'', 品番: it.code, 商品: it.name, 価格: it.price, 初期在庫: it.startStock, 販売済: it.sold, 調整累計: it.adj, 現在庫: stock, 再入荷: it.restock||'' };
  });
  downloadText(toCSV(rows), "stock_"+ts()+".csv");
}
function downloadTxns(){
  var rows = db.txns.map(function(t){ return { 時刻: t.ts, 作家: t.artist, 品番: t.code, 商品: t.name, 数量: t.qty, 単価: t.price, 受取金額: t.受取金額, 釣銭: t.釣銭 }; });
  downloadText(toCSV(rows), "txns_"+ts()+".csv");
}
function downloadAdjs(){
  var rows = db.adjs.map(function(a){ return { 調整ID: a.id, 時刻: a.ts, 作家: a.artist, 品番: a.code, 商品: a.name, 数量: a.qty, 理由: a.reason }; });
  downloadText(toCSV(rows), "adjs_"+ts()+".csv");
}
function downloadBackup(){ downloadText(JSON.stringify(db, null, 2), "backup_all_"+ts()+".json"); }

function hardReset(){
  if(!confirm('全データを初期化します。よろしいですか？')) return;
  db = { artists: [], items: [], txns: [], adjs: [], contacts: [], receipts: [], cashFloats: {} };
  save(); renderArtistTiles(); renderItemTiles(); renderCart(); renderStockTable(); renderAdjCandidates(); renderSummary();
  alert('初期化しました');
}

// ===== Demo =====
function codeFromName(name){
  var ascii = name.replace(/[^\x00-\x7F]/g,'').toUpperCase().replace(/[^A-Z]/g,'');
  if(ascii.length>=3) return ascii.slice(0,3);
  return 'ART';
}
function seedDemo(){
  db = { artists: [], items: [], txns: [], adjs: [], contacts: [], receipts: [], cashFloats: {} };
  var sample = [
    {artist:'青木', code:'101', name:'ポストカードセット', price:500, stock:50},
    {artist:'青木', code:'102-A', name:'缶バッジ（青）', price:300, stock:5},
    {artist:'青木', code:'102-B', name:'缶バッジ（赤）', price:300, stock:3},
    {artist:'佐藤', code:'201', name:'ZINE vol.1', price:1000, stock:30}
  ];
  var seenArtists = {};
  for(var i=0;i<sample.length;i++){
    var s=sample[i];
    if(!seenArtists[s.artist]){
      db.artists.push({ id:'ART-'+(db.artists.length+1), name:s.artist, code: codeFromName(s.artist) });
      seenArtists[s.artist]=1;
    }
    db.items.push({ id:"ITM-"+Date.now()+"-"+Math.random().toString(36).slice(2,7), artist:s.artist, artistCode: codeFromName(s.artist), code:s.code, name:s.name, price:s.price, startStock:s.stock, adj:0, sold:0, restock:'' });
  }
  db.cashFloats[todayYMD()] = 10000;
  save(); initSummaryDates(); renderArtistTiles(); renderItemTiles(); renderStockTable(); renderAdjCandidates(); renderSummary();
  alert('デモデータを投入しました');
}

window.addEventListener('load', load);
</script>
</body>
</html>
